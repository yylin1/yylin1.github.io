<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>我的第一次提交 | Yi Yang&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Kubeflow 課程手把手實作實驗環境 Minikube GPU Cluster Katacoda  kubeflow實作目錄 Jupyter Hub 實作 TF-operator PyTorch-operator  MPI Training">
<meta name="keywords" content="kubernetes,kubeflow,GPU">
<meta property="og:type" content="article">
<meta property="og:title" content="我的第一次提交">
<meta property="og:url" content="http://yylin1.github.io/2018/09/16/我的第一次提交/index.html">
<meta property="og:site_name" content="Yi Yang&#39;s Blog">
<meta property="og:description" content="Kubeflow 課程手把手實作實驗環境 Minikube GPU Cluster Katacoda  kubeflow實作目錄 Jupyter Hub 實作 TF-operator PyTorch-operator  MPI Training">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="https://i.imgur.com/DcXEhyq.png">
<meta property="og:image" content="https://i.imgur.com/wIV6scT.png">
<meta property="og:image" content="https://i.imgur.com/RRVqJ4F.png">
<meta property="og:image" content="https://i.imgur.com/rbBs4Nr.png">
<meta property="og:image" content="https://i.imgur.com/nLBTLxe.png">
<meta property="og:image" content="https://i.imgur.com/qd9vBVm.png">
<meta property="og:updated_time" content="2018-09-16T15:09:20.432Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="我的第一次提交">
<meta name="twitter:description" content="Kubeflow 課程手把手實作實驗環境 Minikube GPU Cluster Katacoda  kubeflow實作目錄 Jupyter Hub 實作 TF-operator PyTorch-operator  MPI Training">
<meta name="twitter:image" content="https://i.imgur.com/DcXEhyq.png">
    

    
        <link rel="alternate" href="/" title="Yi Yang&#39;s Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome5/css/fontawesome.min.css">
    <link rel="stylesheet" href="/libs/font-awesome5/css/fa-brands.min.css">
    <link rel="stylesheet" href="/libs/font-awesome5/css/fa-solid.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Yi Yang&#39;s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/yiyang.png" />
                            <i class="fas fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜尋" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fas fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: 'Pages',
            CATEGORIES: '分類',
            TAGS: '標籤',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜尋" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile" class="profile-fixed">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/yiyang.png" />
            <h2 id="name">Yi Yang</h2>
            <h3 id="title">DevOps Developer</h3>
            <span id="location"><i class="fas fa-map-marker-alt" style="padding-right: 5px"></i>Taichung, Taiwan</span>
            <a id="follow" target="_blank" href="https://github.com/yylin1/">關注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                2
                <span>文章</span>
            </div>
            <div class="article-info-block">
                3
                <span>標籤</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/yylin1" target="_blank" title="github" class=tooltip>
                            <i class="fab fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fab fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fab fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fab fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fab fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-我的第一次提交" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            我的第一次提交
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fas fa-calendar-alt"></i>
        <a href="/2018/09/16/我的第一次提交/">
            <time datetime="2018-09-16T06:47:18.000Z" itemprop="datePublished">2018-09-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fas fa-folder"></i>
        <a class="article-category-link" href="/categories/kubernetes/">kubernetes</a>
    </div>

                        
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/GPU/">GPU</a>, <a class="tag-link" href="/tags/kubeflow/">kubeflow</a>, <a class="tag-link" href="/tags/kubernetes/">kubernetes</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Kubeflow-課程手把手實作"><a href="#Kubeflow-課程手把手實作" class="headerlink" title="Kubeflow 課程手把手實作"></a>Kubeflow 課程手把手實作</h1><h2 id="實驗環境"><a href="#實驗環境" class="headerlink" title="實驗環境"></a>實驗環境</h2><ul>
<li>Minikube</li>
<li>GPU Cluster</li>
<li>Katacoda</li>
</ul>
<h2 id="kubeflow實作目錄"><a href="#kubeflow實作目錄" class="headerlink" title="kubeflow實作目錄"></a>kubeflow實作目錄</h2><ul>
<li>Jupyter Hub 實作</li>
<li>TF-operator</li>
<li>PyTorch-operator </li>
<li>MPI Training<a id="more"></a> 
</li>
</ul>
<blockquote>
<p>更多實作｜<a href="https://www.kubeflow.org/docs/started/getting-started/" target="_blank" rel="noopener">參考</a></p>
</blockquote>
<h3 id="其他可以透過-katacoda-線上學習"><a href="#其他可以透過-katacoda-線上學習" class="headerlink" title="其他可以透過 katacoda 線上學習"></a>其他可以透過 katacoda 線上學習</h3><ul>
<li>Deploying Github Issue Summarization with Kubeflow</li>
<li>Deploying PyTorch with Kubeflow</li>
<li>Deploying Kubeflow</li>
<li>Deploying Kubeflow with Ksonnet</li>
</ul>
<hr>
<h1 id="minikube-部署kubeflow"><a href="#minikube-部署kubeflow" class="headerlink" title="minikube 部署kubeflow"></a>minikube 部署kubeflow</h1><h4 id="確認已經部署完成-minikube"><a href="#確認已經部署完成-minikube" class="headerlink" title="確認已經部署完成 minikube"></a>確認已經部署完成 minikube</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.6</span><br></pre></td></tr></table></figure>
<h2 id="ksonnet-install"><a href="#ksonnet-install" class="headerlink" title="ksonnet install"></a>ksonnet install</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/ksonnet/ksonnet/releases/download/v0.11.0/ks_0.11.0_linux_amd64.tar.gz | tar xvz &amp;&amp; mv ks_0.11.0_linux_amd64/ks /usr/local/bin/ks &amp;&amp; rm -rf ks_0.11.0_linux_amd64/</span><br></pre></td></tr></table></figure>
<h3 id="kubeflow-install"><a href="#kubeflow-install" class="headerlink" title="kubeflow install"></a>kubeflow install</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export KUBEFLOW_VERSION=0.2.2</span><br><span class="line">curl https://raw.githubusercontent.com/kubeflow/kubeflow/v0.2.2/scripts/deploy.sh | bash</span><br></pre></td></tr></table></figure>
<p>檢查部署後狀態 （會需要花時間下載Images）<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get pods</span><br><span class="line"></span><br><span class="line">NAME                                        READY     STATUS    RESTARTS   AGE</span><br><span class="line">ambassador-59cb5ccd89-cltqx                 2/2       Running   0          1m</span><br><span class="line">ambassador-59cb5ccd89-sl87k                 2/2       Running   0          1m</span><br><span class="line">ambassador-59cb5ccd89-szchn                 2/2       Running   0          1m</span><br><span class="line">centraldashboard-7d7744cccb-cntj6           1/1       Running   0          1m</span><br><span class="line">spartakus-volunteer-55577f4bd9-kgnvv        1/1       Running   0          1m</span><br><span class="line">tf-hub-0                                    1/1       Running   0          1m</span><br><span class="line">tf-job-dashboard-bfc9bc6bc-wmbj5            1/1       Running   0          1m</span><br><span class="line">tf-job-operator-v1alpha2-756cf9cb97-r45kk   1/1       Running   0          1m</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="補充：Minikube-for-Kubeflow-Bootstrapper"><a href="#補充：Minikube-for-Kubeflow-Bootstrapper" class="headerlink" title="補充：Minikube for Kubeflow (Bootstrapper)"></a>補充：Minikube for Kubeflow (Bootstrapper)</h3><p>安裝kubeflow 使用 Bootstrapper</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl -O https://raw.githubusercontent.com/kubeflow/kubeflow/v0.2-branch/bootstrap/bootstrapper.yaml</span><br></pre></td></tr></table></figure>
<p>執行config</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl create -f bootstrapper.yaml</span><br></pre></td></tr></table></figure>
<p>創建的項目<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">namespace "kubeflow-admin" created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io "kubeflow-cluster-admin" created</span><br><span class="line">persistentvolumeclaim "kubeflow-ksonnet-pvc" created</span><br><span class="line">statefulset.apps "kubeflow-bootstrapper" created</span><br></pre></td></tr></table></figure></p>
<p>查看是否建立成功<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get ns</span><br><span class="line">NAME             STATUS    AGE</span><br><span class="line">default          Active    1m</span><br><span class="line">kube-public      Active    1m</span><br><span class="line">kube-system      Active    1m</span><br><span class="line">kubeflow-admin   Active    53s</span><br></pre></td></tr></table></figure></p>
<p>這步驟會需要5~8分鐘時間，需要下載各項Images<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kubeflow get svc</span><br><span class="line">NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">ambassador         ClusterIP   10.97.168.31     &lt;none&gt;        80/TCP     1m</span><br><span class="line">ambassador-admin   ClusterIP   10.99.5.81       &lt;none&gt;        8877/TCP   1m</span><br><span class="line">centraldashboard   ClusterIP   10.111.104.142   &lt;none&gt;        80/TCP     1m</span><br><span class="line">k8s-dashboard      ClusterIP   10.102.65.244    &lt;none&gt;        443/TCP    1m</span><br><span class="line">tf-hub-0           ClusterIP   None             &lt;none&gt;        8000/TCP   1m</span><br><span class="line">tf-hub-lb          ClusterIP   10.101.15.28     &lt;none&gt;        80/TCP     1m</span><br><span class="line">tf-job-dashboard   ClusterIP   10.106.133.49    &lt;none&gt;        80/TCP     1m</span><br></pre></td></tr></table></figure></p>
<p>啟用Jupyter Hub與 kubeflow Dashboard<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> POD=`kubectl -n kubeflow get pods --selector=service=ambassador | awk '&#123;print $1&#125;' | tail -1`</span><br><span class="line"><span class="meta">$</span> kubectl -n kubeflow port-forward $POD 8080:80 2&gt;&amp;1 &gt;/dev/null &amp;</span><br><span class="line"><span class="meta">$</span> POD=`kubectl -n kubeflow get pods --selector=app=tf-hub | awk '&#123;print $1&#125;' | tail -1`</span><br><span class="line"><span class="meta">$</span> kubectl -n kubeflow port-forward $POD 8000:8000 2&gt;&amp;1 &gt;/dev/null &amp;</span><br></pre></td></tr></table></figure></p>
<p>Kubeflow dashboard at <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a><br>JupyterHub at <a href="http://localhost:8000/" target="_blank" rel="noopener">http://localhost:8000/</a></p>
<hr>
<h3 id="Upgrading-Kubeflow-Deployments"><a href="#Upgrading-Kubeflow-Deployments" class="headerlink" title="Upgrading Kubeflow Deployments"></a>Upgrading Kubeflow Deployments</h3><ul>
<li>如果CRD API 後續如何更新？</li>
</ul>
<p>刪除TFJobs v1alpha1，因為K8無法部署多個版本的CRD<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete crd tfjobs.kubeflow.org</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="Jupyter-Hub-測試-Kubeflow"><a href="#Jupyter-Hub-測試-Kubeflow" class="headerlink" title="Jupyter Hub 測試 Kubeflow"></a>Jupyter Hub 測試 Kubeflow</h2><p>檢查 Kubeflow 元件部署結果<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get pods                                      </span><br><span class="line">NAME                                        READY     STATUS    RESTARTS   AGE</span><br><span class="line">ambassador-59cb5ccd89-mxdpz                 2/2       Running   0          13m</span><br><span class="line">ambassador-59cb5ccd89-nzcbt                 2/2       Running   0          13m</span><br><span class="line">ambassador-59cb5ccd89-rzrs5                 2/2       Running   0          13m</span><br><span class="line">centraldashboard-7d7744cccb-kh7r6           1/1       Running   0          13m</span><br><span class="line">spartakus-volunteer-56d4cf6bbf-vf9nt        1/1       Running   0          13m</span><br><span class="line">tf-hub-0                                    1/1       Running   0          13m</span><br><span class="line">tf-job-dashboard-bfc9bc6bc-zfk64            1/1       Running   0          13m</span><br><span class="line">tf-job-operator-v1alpha2-756cf9cb97-w2w9q   1/1       Running   0          13m</span><br></pre></td></tr></table></figure></p>
<p>確認後就可以登入 Jupyter Notebook，但這邊需要修改 Kubernetes Service，透過以下指令進行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl -n default edit svc tf-hub-lb</span><br><span class="line">···</span><br><span class="line">spec:</span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">  type: NodePort</span><br><span class="line">···</span><br></pre></td></tr></table></figure>
<p>查看minikube ip<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> minikube ip </span><br><span class="line">192.168.99.100</span><br></pre></td></tr></table></figure></p>
<p>確認Service對應的IP:port<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get svc                                       </span><br><span class="line">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">ambassador         ClusterIP   10.97.154.89    &lt;none&gt;        80/TCP         15m</span><br><span class="line">ambassador-admin   ClusterIP   10.107.124.60   &lt;none&gt;        8877/TCP       15m</span><br><span class="line">centraldashboard   ClusterIP   10.107.126.80   &lt;none&gt;        80/TCP         15m</span><br><span class="line">k8s-dashboard      ClusterIP   10.103.240.15   &lt;none&gt;        443/TCP        15m</span><br><span class="line">kubernetes         ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        17m</span><br><span class="line">tf-hub-0           ClusterIP   None            &lt;none&gt;        8000/TCP       15m</span><br><span class="line">tf-hub-lb          NodePort    10.100.10.226   &lt;none&gt;        80:30552/TCP   15m</span><br><span class="line">tf-job-dashboard   ClusterIP   10.97.210.229   &lt;none&gt;        80/TCP         15m</span><br></pre></td></tr></table></figure></p>
<p>連接對應的<code>192.168.99.100:30552</code>即可以開啟Jupyer Hub<br><em>帳密自行輸入,會自動建立新帳號</em></p>
<p><img src="https://i.imgur.com/DcXEhyq.png" alt=""></p>
<p>登入後點選Start My Server按鈕來建立 Server 的 Spawner options，預設會有多種映像檔可以使用：</p>
<p><img src="https://i.imgur.com/wIV6scT.png" alt=""></p>
<p>選擇資源後就會看到minikube環境pod就會多一個 <code>jupyter-admin</code> container正在建立</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">NAME                                        READY     STATUS              RESTARTS   AGE</span><br><span class="line">ambassador-59cb5ccd89-mxdpz                 2/2       Running             0          21m</span><br><span class="line">ambassador-59cb5ccd89-nzcbt                 2/2       Running             0          21m</span><br><span class="line">ambassador-59cb5ccd89-rzrs5                 2/2       Running             0          21m</span><br><span class="line">centraldashboard-7d7744cccb-kh7r6           1/1       Running             0          21m</span><br><span class="line">jupyter-admin                               0/1       ContainerCreating   0          3m</span><br><span class="line">spartakus-volunteer-56d4cf6bbf-vf9nt        1/1       Running             0          21m</span><br><span class="line">tf-hub-0                                    1/1       Running             0          21m</span><br><span class="line">tf-job-dashboard-bfc9bc6bc-zfk64            1/1       Running             0          21m</span><br><span class="line">tf-job-operator-v1alpha2-756cf9cb97-w2w9q   1/1       Running             0          21m</span><br></pre></td></tr></table></figure>
<p>下載時間Images都需要時間，也可以自己實作Build Dockerfile，生成後可以直接透過Jupyter Notebook做操作。</p>
<p>查看Pod生成狀態<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod jupyter-admin</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason                 Age   From               Message</span><br><span class="line">  ----    ------                 ----  ----               -------</span><br><span class="line">  Normal  Scheduled              34s   default-scheduler  Successfully assigned jupyter-admin to minikube</span><br><span class="line">  Normal  SuccessfulMountVolume  34s   kubelet, minikube  MountVolume.SetUp succeeded for volume &quot;pvc-11a86a3d-a8cd-11e8-8ff4-080027920b17&quot;</span><br><span class="line">  Normal  SuccessfulMountVolume  34s   kubelet, minikube  MountVolume.SetUp succeeded for volume &quot;no-api-access-please&quot;</span><br><span class="line">  Normal  Pulling                33s   kubelet, minikube  pulling image &quot;gcr.io/kubeflow/tensorflow-notebook-cpu:latest</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>如果環境下載太慢，可以嘗試連接已經部署好的環境，使用JupyterHub<br><a href="http://140.128.18.98:31715/" target="_blank" rel="noopener">http://140.128.18.98:31715/</a></p>
</blockquote>
<p><img src="https://i.imgur.com/RRVqJ4F.png" alt=""><br><img src="https://i.imgur.com/rbBs4Nr.png" alt=""><br><img src="https://i.imgur.com/nLBTLxe.png" alt=""></p>
<hr>
<h2 id="Kubeflow-Use-TF-operator"><a href="#Kubeflow-Use-TF-operator" class="headerlink" title="Kubeflow Use TF-operator"></a>Kubeflow Use TF-operator</h2><p>確認已經下載kubeflow-broadmission<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/kairen/kubeflow-broadmission.git</span><br></pre></td></tr></table></figure></p>
<p><code>TFJob</code>是一個Kubernetes 自定義資源(CRD)，可以在Kubernetes上輕鬆運行TensorFlow訓練工作</p>
<p>進入tf-operator資料夾，執行簡易的tfjob測試<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl create -f tf-job-cpu.yml</span><br></pre></td></tr></table></figure></p>
<p>執行 yaml如下<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeflow.org/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TFJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    experiment:</span> <span class="string">experiment10</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tfjob</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubeflow</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  tfReplicaSpecs:</span></span><br><span class="line"><span class="attr">    Ps:</span></span><br><span class="line"><span class="attr">      replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        metadata:</span></span><br><span class="line"><span class="attr">          creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">          - args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">python</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">tf_cnn_benchmarks.py</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--batch_size=32</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--model=resnet50</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--variable_update=parameter_server</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--flush_stdout=true</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--num_gpus=1</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--local_parameter_device=cpu</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--device=cpu</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--data_format=NHWC</span></span><br><span class="line"><span class="attr">            image:</span> <span class="string">gcr.io/kubeflow/tf-benchmarks-cpu:v20171202-bdab599-dirty-284af3</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">tensorflow</span></span><br><span class="line"><span class="attr">            ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">2222</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">tfjob-port</span></span><br><span class="line"><span class="attr">            resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">            workingDir:</span> <span class="string">/opt/tf-benchmarks/scripts/tf_cnn_benchmarks</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">    Worker:</span></span><br><span class="line"><span class="attr">      replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        metadata:</span></span><br><span class="line"><span class="attr">          creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">          - args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">python</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">tf_cnn_benchmarks.py</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--batch_size=32</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--model=resnet50</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--variable_update=parameter_server</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--flush_stdout=true</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--num_gpus=1</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--local_parameter_device=cpu</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--device=cpu</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--data_format=NHWC</span></span><br><span class="line"><span class="attr">            image:</span> <span class="string">gcr.io/kubeflow/tf-benchmarks-cpu:v20171202-bdab599-dirty-284af3</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">tensorflow</span></span><br><span class="line"><span class="attr">            ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">2222</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">tfjob-port</span></span><br><span class="line"><span class="attr">            resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">            workingDir:</span> <span class="string">/opt/tf-benchmarks/scripts/tf_cnn_benchmarks</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">OnFailur</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>透過TF-operator管理，我們可以透過調整replicas來增加分散式訓練的works數量</p>
</blockquote>
<p>確認執行tfjob狀態<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get tfjob                                         </span><br><span class="line">NAME      CREATED AT</span><br><span class="line">tfjob     5m</span><br></pre></td></tr></table></figure></p>
<p>監控tfjob狀態<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get -o yaml tfjobs $JOB</span><br><span class="line"></span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: 2018-08-26T03:57:32Z</span><br><span class="line">    lastUpdateTime: 2018-08-26T03:57:32Z</span><br><span class="line">    message: TFJob tfjob is running.</span><br><span class="line">    reason: TFJobRunning</span><br><span class="line">    status: "True"</span><br><span class="line">    type: Running</span><br><span class="line">  startTime: 2018-08-26T04:11:33Z</span><br><span class="line">  tfReplicaStatuses:</span><br><span class="line">    PS:</span><br><span class="line">      active: 1</span><br><span class="line">    Worker:</span><br><span class="line">      active: 1</span><br></pre></td></tr></table></figure></p>
<p>可以透過確認tfjob執行狀態<code>Running</code></p>
<p>透過觀察tfjob生成tf-benchmarks 包含PS、worker 目前pod狀態<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line"></span><br><span class="line">NAME                                        READY     STATUS    RESTARTS   AGE</span><br><span class="line">ambassador-59cb5ccd89-mxdpz                 2/2       Running   0          1h</span><br><span class="line">ambassador-59cb5ccd89-nzcbt                 2/2       Running   0          1h</span><br><span class="line">ambassador-59cb5ccd89-rzrs5                 2/2       Running   0          1h</span><br><span class="line">centraldashboard-7d7744cccb-kh7r6           1/1       Running   0          1h</span><br><span class="line">jupyter-admin                               1/1       Running   0          1h</span><br><span class="line">spartakus-volunteer-56d4cf6bbf-vf9nt        1/1       Running   0          1h</span><br><span class="line">tf-hub-0                                    1/1       Running   0          1h</span><br><span class="line">tf-job-dashboard-bfc9bc6bc-zfk64            1/1       Running   0          1h</span><br><span class="line">tf-job-operator-v1alpha2-756cf9cb97-w2w9q   1/1       Running   0          1h</span><br><span class="line">tfjob-ps-0                                  1/1       Running   0          23m</span><br><span class="line">tfjob-worker-0                              1/1       Running   0          23m</span><br></pre></td></tr></table></figure></p>
<p>觀察tfjob-worker-0狀態<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl logs -f tfjob-worker-0</span><br><span class="line"></span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| TensorFlow:  1.5</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Model:       resnet50</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Mode:        training</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| SingleSess:  False</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Batch size:  32 global</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| 32 per device</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Devices:     ['/job:worker/task:0/cpu:0']</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Data format: NHWC</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Optimizer:   sgd</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Variables:   parameter_server</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Sync:        True</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| ==========</span><br><span class="line">INFO|2018-08-26T03:57:34|/opt/launcher.py|27| Generating model</span><br><span class="line">INFO|2018-08-26T03:57:41|/opt/launcher.py|27| 2018-08-26 03:57:41.378160: I tensorflow/core/distributed_runtime/master_session.cc:1008] Start master session 1d102ed86769e21e with config: intra_op_parallelism_threads: 1 gpu_options &#123; force_gpu_compatible: true &#125; allow_soft_placement: true</span><br><span class="line">INFO|2018-08-26T03:57:44|/opt/launcher.py|27| Running warm up</span><br><span class="line">INFO|2018-08-26T04:10:31|/opt/launcher.py|27| Done warm up</span><br><span class="line">INFO|2018-08-26T04:10:31|/opt/launcher.py|27| Step	Img/sec	loss</span><br><span class="line">INFO|2018-08-26T04:11:52|/opt/launcher.py|27| 1	images/sec: 0.4 +/- 0.0 (jitter = 0.0)	10.224</span><br></pre></td></tr></table></figure></p>
<p>如果要直接刪除<code>tfjob</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ks -n $&#123;NAMESPACE&#125; delete tfjobs &#123;JOB_NAME&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="kubeflow-MPI"><a href="#kubeflow-MPI" class="headerlink" title="kubeflow MPI"></a>kubeflow MPI</h2><p><img src="https://i.imgur.com/qd9vBVm.png" alt=""></p>
<blockquote>
<p><a href="https://github.com/uber/horovod/blob/master/docs/benchmarks.md" target="_blank" rel="noopener">連結</a><br>這邊直接參考資料夾 yaml範例</p>
</blockquote>
<p>檢查是否已安裝mpijobs自定義資源<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get crd</span><br><span class="line">NAME                                       AGE</span><br><span class="line">...</span><br><span class="line">mpijobs.kubeflow.org                       4d</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>可以透過kosnnet添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd $&#123;KSONNET_APP&#125;</span><br><span class="line">ks pkg install kubeflow/mpi-job</span><br><span class="line">ks generate mpi-operator mpi-operator</span><br><span class="line">ks apply $&#123;ENVIRONMENT&#125; -c mpi-operator</span><br></pre></td></tr></table></figure></p>
<p>或是直接create crd.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: mpijobs.kubeflow.org</span><br><span class="line">spec:</span><br><span class="line">  group: kubeflow.org</span><br><span class="line">  version: v1alpha1</span><br><span class="line">  scope: Namespaced</span><br><span class="line">  names:</span><br><span class="line">    plural: mpijobs</span><br><span class="line">    singular: mpijob</span><br><span class="line">    kind: MPIJob</span><br><span class="line">    shortNames:</span><br><span class="line">    - mj</span><br><span class="line">    - mpij</span><br><span class="line">  validation:</span><br><span class="line">    openAPIV3Schema:</span><br><span class="line">      properties:</span><br><span class="line">        spec:</span><br><span class="line">          title: The MPIJob spec</span><br><span class="line">          description: Either `gpus` or `replicas` should be specified, but not both</span><br><span class="line">          oneOf:</span><br><span class="line">          - properties:</span><br><span class="line">              gpus:</span><br><span class="line">                title: Total number of GPUs</span><br><span class="line">                description: Valid values are 1, 2, 4, or any multiple of 8</span><br><span class="line">                oneOf:</span><br><span class="line">                - type: integer</span><br><span class="line">                  enum:</span><br><span class="line">                  - 1</span><br><span class="line">                  - 2</span><br><span class="line">                  - 4</span><br><span class="line">                - type: integer</span><br><span class="line">                  multipleOf: 8</span><br><span class="line">                  minimum: 8</span><br><span class="line">            required:</span><br><span class="line">            - gpus</span><br><span class="line">          - properties:</span><br><span class="line">              replicas:</span><br><span class="line">                title: Total number of replicas</span><br><span class="line">                description: The GPU resource limit should be specified for each replica</span><br><span class="line">                type: integer</span><br><span class="line">                minimum: 1</span><br><span class="line">            required:</span><br><span class="line">            - replicas</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Kubeflow-Deploy-Pytorch"><a href="#Kubeflow-Deploy-Pytorch" class="headerlink" title="Kubeflow Deploy Pytorch"></a>Kubeflow Deploy Pytorch</h2><p>Kubeflow使用自定義資源定義（CRD）和Operator擴展了Kubernetes。<br>每個自定義資源都是協助機器學習工作負載的部署。定義資源後，Operator將處理部署請求。</p>
<p>查看目前環境中的CRD資源：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get crd</span><br><span class="line"></span><br><span class="line">NAME                  CREATED AT</span><br><span class="line">tfjobs.kubeflow.org   2018-08-26T02:56:54Z</span><br></pre></td></tr></table></figure></p>
<p>在kubeflow 0.2.2，默認是沒有部署Pytorch Operator，需要額外下命令部署CRD和Operator。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd kubeflow_ks_app</span><br><span class="line">ks generate pytorch-operator pytorch-operator</span><br><span class="line">ks apply default -c pytorch-operator</span><br></pre></td></tr></table></figure></p>
<p>重新查看<code>kubectl get crd</code>確認<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get crd</span><br><span class="line">NAME                       AGE</span><br><span class="line">pytorchjobs.kubeflow.org   6m</span><br><span class="line">tfjobs.kubeflow.org        8m</span><br></pre></td></tr></table></figure></p>
<p>Download pytorch-operator<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/yylin1/kubeflow-broadmission.git</span><br></pre></td></tr></table></figure></p>
<p>測試mnist訓練需要事先部署Docker Image<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd pytorch-operator/examples/dist-mnist/</span><br><span class="line">docker build -f Dockerfile -t kubeflow / pytorch-dist-mnist-test：1.0 ./</span><br></pre></td></tr></table></figure></p>
<h3 id="PyTorch-分散式訓練"><a href="#PyTorch-分散式訓練" class="headerlink" title="PyTorch 分散式訓練"></a>PyTorch 分散式訓練</h3><p>分佈式MNIST模型已打包到Container Image中。可以在Github上查看Python PyTorch代碼。</p>
<p>要部署培訓模型，PyTorchJob需要。這定義了要使用的容器映像以及用於分發培訓的副本數。</p>
<p>可以查看一個示例 <code>cat examples/dist-mnist/pytorch_job_mnist.yaml</code><br>執行部屬<code>PyTorchJob</code>開始訓練：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f examples/dist-mnist/pytorch_job_mnist.yaml</span><br></pre></td></tr></table></figure></p>
<p>查看目前創建的Pod與指定的Work副本數量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -l pytorch_job_name=dist-mnist-for-e2e-test</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AME                                          READY     STATUS              RESTARTS   AGE</span><br><span class="line">dist-mnist-for-e2e-test-master-nl90-0-tcbly   0/1       ContainerCreating   0          5s</span><br><span class="line">dist-mnist-for-e2e-test-worker-nl90-1-wtidy   0/1       ContainerCreating   0          4s</span><br><span class="line">dist-mnist-for-e2e-test-worker-nl90-2-8t25x   0/1       ContainerCreating   0          3s</span><br><span class="line">dist-mnist-for-e2e-test-worker-nl90-3-t1i6z   0/1       ContainerCreating   0          3s</span><br></pre></td></tr></table></figure>
<p>預設minist訓練為10個epoch約需要在Cluster執行5-10分鐘。可以透過查看日誌了解訓練進度。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PODNAME=$(kubectl get pods -l pytorch_job_name=dist-mnist-for-e2e-test,task_index=0 -o name)</span><br><span class="line">kubectl logs -f $&#123;PODNAME&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl logs -f $&#123;PODNAME&#125;</span><br><span class="line">Downloading http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz</span><br><span class="line">Downloading http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz</span><br><span class="line">Downloading http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz</span><br><span class="line">Downloading http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz</span><br><span class="line">Processing...</span><br><span class="line">Done!</span><br><span class="line">Rank  0 , epoch  0 :  1.2745472780232237</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<p>監控PyTorch任務是否完成<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get -o yaml pytorchjobs dist-mnist-for-e2e-test</span><br></pre></td></tr></table></figure></p>
<p>可以透過輸出<code>yaml</code>來監控Job狀態。Job執行完成後<code>state: Succeeded</code>顯示成功。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="attr">- apiVersion:</span> <span class="string">kubeflow.org/v1alpha1</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">PyTorchJob</span></span><br><span class="line"><span class="attr">  metadata:</span></span><br><span class="line"><span class="attr">    clusterName:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    creationTimestamp:</span> <span class="number">2018</span><span class="bullet">-06</span><span class="bullet">-22</span><span class="attr">T08:16:14Z</span></span><br><span class="line"><span class="attr">    generation:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">dist-mnist-for-e2e-test</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    resourceVersion:</span> <span class="string">"3276193"</span></span><br><span class="line"><span class="attr">    selfLink:</span> <span class="string">/apis/kubeflow.org/v1alpha1/namespaces/default/pytorchjobs/dist-mnist-for-e2e-test</span></span><br><span class="line"><span class="attr">    uid:</span> <span class="number">87772</span><span class="string">d3b-75f4-11e8-bdd9-42010aa00072</span></span><br><span class="line"><span class="attr">  spec:</span></span><br><span class="line"><span class="attr">    RuntimeId:</span> <span class="string">kmma</span></span><br><span class="line"><span class="attr">    pytorchImage:</span> <span class="string">pytorch/pytorch:v0.2</span></span><br><span class="line"><span class="attr">    replicaSpecs:</span></span><br><span class="line"><span class="attr">    - masterPort:</span> <span class="number">23456</span></span><br><span class="line"><span class="attr">      replicaType:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">      replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        metadata:</span></span><br><span class="line"><span class="attr">          creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">          - image:</span> <span class="string">gcr.io/kubeflow-ci/pytorch-dist-mnist_test:1.0</span></span><br><span class="line"><span class="attr">            imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">pytorch</span></span><br><span class="line"><span class="attr">            resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">    - masterPort:</span> <span class="number">23456</span></span><br><span class="line"><span class="attr">      replicaType:</span> <span class="string">WORKER</span></span><br><span class="line"><span class="attr">      replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        metadata:</span></span><br><span class="line"><span class="attr">          creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">          - image:</span> <span class="string">gcr.io/kubeflow-ci/pytorch-dist-mnist_test:1.0</span></span><br><span class="line"><span class="attr">            imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">pytorch</span></span><br><span class="line"><span class="attr">            resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">    terminationPolicy:</span></span><br><span class="line"><span class="attr">      master:</span></span><br><span class="line"><span class="attr">        replicaName:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">        replicaRank:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  status:</span></span><br><span class="line"><span class="attr">    phase:</span> <span class="string">Done</span></span><br><span class="line"><span class="attr">    reason:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    replicaStatuses:</span></span><br><span class="line"><span class="attr">    - ReplicasStates:</span></span><br><span class="line"><span class="attr">        Succeeded:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      replica_type:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">Succeeded</span></span><br><span class="line"><span class="attr">    - ReplicasStates:</span></span><br><span class="line"><span class="attr">        Running:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">        Succeeded:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">      replica_type:</span> <span class="string">WORKER</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">Running</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">Succeeded</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  resourceVersion:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  selfLink:</span> <span class="string">""</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="若想從-Kubernetes-叢集刪除-Kubeflow-相關元件的話，可執行下列指令達成："><a href="#若想從-Kubernetes-叢集刪除-Kubeflow-相關元件的話，可執行下列指令達成：" class="headerlink" title="若想從 Kubernetes 叢集刪除 Kubeflow 相關元件的話，可執行下列指令達成："></a>若想從 Kubernetes 叢集刪除 Kubeflow 相關元件的話，可執行下列指令達成：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ks delete default -c kubeflow-core</span><br></pre></td></tr></table></figure>
<h2 id="補充kubeflow-0-2-Components"><a href="#補充kubeflow-0-2-Components" class="headerlink" title="補充kubeflow 0.2 Components"></a>補充kubeflow 0.2 Components</h2><ul>
<li>TensorFlow Training</li>
<li>Hyperparameter Tuning (Katib)</li>
<li>Seldon Serving</li>
<li>Istio Integration (for TF Serving)</li>
<li>..</li>
</ul>
<blockquote>
<p><a href="https://www.kubeflow.org/" target="_blank" rel="noopener">kubeflow</a></p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yylin1.github.io/2018/09/16/我的第一次提交/" data-id="cjm4zuddi0002i3ont5ushb1t" class="article-share-link"><i class="fas fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fab fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fab fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fab fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fab fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2018/09/15/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">Hello World</div>
        </a>
    
</nav>


    
</article>


    
    

</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/09/16/我的第一次提交/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/kubernetes/">kubernetes</a></p>
                            <p class="item-title"><a href="/2018/09/16/我的第一次提交/" class="title">我的第一次提交</a></p>
                            <p class="item-date"><time datetime="2018-09-16T06:47:18.000Z" itemprop="datePublished">2018-09-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/09/15/hello-world/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/09/15/hello-world/" class="title">Hello World</a></p>
                            <p class="item-date"><time datetime="2018-09-15T05:39:24.352Z" itemprop="datePublished">2018-09-15</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分類</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">歸檔</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">標籤</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPU/">GPU</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubeflow/">kubeflow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">標籤雲</h3>
        <div class="widget tagcloud">
            <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/kubeflow/" style="font-size: 10px;">kubeflow</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">連結</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fas fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 Yi Yang<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>