<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>透過 Ansible 快速部署 OpenShift 3.11(OKD) 叢集 - Yi Yang&#039;s Blog</title><meta description="本篇將介紹透過 OpenShift Ansible 來快速部署 RedHat OpenShift 社區版本 OKD (The Origin Community Distribution of Kubernetes) 的 release-3.11 版本，此篇文章主要是用來筆記學習裸機機器(Bare-metal Server)部署過程與環境架構。 共同編輯: Hank Lin - 靠著13%技術與87"><meta property="og:type" content="blog"><meta property="og:title" content="透過 Ansible 快速部署 OpenShift 3.11(OKD) 叢集"><meta property="og:url" content="http://yylin1.github.io/2019/08/12/openshift-ansible-v3-11/"><meta property="og:site_name" content="Yi Yang&#039;s Blog"><meta property="og:description" content="本篇將介紹透過 OpenShift Ansible 來快速部署 RedHat OpenShift 社區版本 OKD (The Origin Community Distribution of Kubernetes) 的 release-3.11 版本，此篇文章主要是用來筆記學習裸機機器(Bare-metal Server)部署過程與環境架構。 共同編輯: Hank Lin - 靠著13%技術與87"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="http://yylin1.github.io/images/openshift%203.11.jpg"><meta property="article:published_time" content="2019-08-12T15:41:13.000Z"><meta property="article:modified_time" content="2019-09-07T03:40:13.000Z"><meta property="article:author" content="Yi Yang"><meta property="article:tag" content="ansible"><meta property="article:tag" content="openshift"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/openshift%203.11.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yylin1.github.io/2019/08/12/openshift-ansible-v3-11/"},"headline":"Yi Yang's Blog","image":["http://yylin1.github.io/images/openshift%203.11.jpg"],"datePublished":"2019-08-12T15:41:13.000Z","dateModified":"2019-09-07T03:40:13.000Z","author":{"@type":"Person","name":"Yi Yang"},"description":"本篇將介紹透過 OpenShift Ansible 來快速部署 RedHat OpenShift 社區版本 OKD (The Origin Community Distribution of Kubernetes) 的 release-3.11 版本，此篇文章主要是用來筆記學習裸機機器(Bare-metal Server)部署過程與環境架構。 共同編輯: Hank Lin - 靠著13%技術與87"}</script><link rel="canonical" href="http://yylin1.github.io/2019/08/12/openshift-ansible-v3-11/"><link rel="icon" href="/images/artificial-intelligence.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/androidstudio.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/artificial-intelligence.png" alt="Yi Yang&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="http://photography.yylin.io">Photo</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="文章目錄" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜尋" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="/images/openshift%203.11.jpg" alt="透過 Ansible 快速部署 OpenShift 3.11(OKD) 叢集"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-08-12T15:41:13.000Z" title="2019-08-12T15:41:13.000Z">2019-08-12</time><span class="level-item"><a class="link-muted" href="/categories/Openshift/">Openshift</a></span><span class="level-item">16 分鐘 閱讀文 (大約 2443 個字)</span></div></div><h1 class="title is-3 is-size-4-mobile">透過 Ansible 快速部署 OpenShift 3.11(OKD) 叢集</h1><div class="content"><p>本篇將介紹透過 <a href="https://github.com/openshift/openshift-ansible" target="_blank" rel="noopener">OpenShift Ansible</a> 來快速部署 RedHat OpenShift 社區版本 <code>OKD (The Origin Community Distribution of Kubernetes)</code> 的 <code>release-3.11</code> 版本，此篇文章主要是用來筆記學習裸機機器(Bare-metal Server)部署過程與環境架構。</p>
<p>共同編輯: <a href="https://chlin62.github.io/okd-311-deploy-cluster/" target="_blank" rel="noopener">Hank Lin - 靠著13%技術與87%嘴砲</a></p>
<a id="more"></a>
<h2 id="實驗節點資訊"><a href="#實驗節點資訊" class="headerlink" title="實驗節點資訊"></a>實驗節點資訊</h2><p>本次安裝作業系統採用 <strong>CentOS 7</strong>，測試環境為實體主機：</p>
<table>
<thead>
<tr>
<th>IP Address</th>
<th>Hostname</th>
<th>Sepc</th>
<th>Remark</th>
<th>Hard Disk Drive</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.101.130</td>
<td>paas01</td>
<td>8 core/ 8G</td>
<td>Master node</td>
<td>SSD 256 GB</td>
</tr>
<tr>
<td>192.168.101.131</td>
<td>paas02</td>
<td>8 core/ 8G</td>
<td>Infra node</td>
<td>HDD 1TB</td>
</tr>
<tr>
<td>192.168.101.132</td>
<td>paas03</td>
<td>8 core/ 8G</td>
<td>AP node</td>
<td>HDD 1TB</td>
</tr>
<tr>
<td>192.168.101.133</td>
<td>paas04</td>
<td>8 core/ 8G</td>
<td>AP node</td>
<td>HDD 500 GB</td>
</tr>
<tr>
<td>192.168.101.134</td>
<td>paas05</td>
<td>8 core/ 8G</td>
<td>AP node</td>
<td>HDD 500 GB</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ISO: Centos-7-x86_64-Minimal-1810.iso</p>
</blockquote>
<h2 id="實驗-部署節點架構圖"><a href="#實驗-部署節點架構圖" class="headerlink" title="實驗-部署節點架構圖"></a>實驗-部署節點架構圖</h2><h3 id="OKD-System-Architecture"><a href="#OKD-System-Architecture" class="headerlink" title="OKD: System Architecture"></a>OKD: System Architecture</h3><ul>
<li>這次部署的架構主要是針對 <code>small size</code> 的 Single Master and Infra node 的架構進行部署</li>
<li>Production 環境建議採用 HA 架構的 OKD cluster</li>
<li>所有進出 Cluster 流量會透過 Infra Node 進行流量進出，Web based (http/https and ws/wss) 會透過 Infra node 中的 HAProxy 進出，TCP based 的則透過 External IP</li>
</ul>
<figure class="highlight rust hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Route(Ingress Controller)            +---------------------+</span><br><span class="line">*.apps.paas.domain.tw                |    Master node      |</span><br><span class="line">  +----------------+                 |---------------------| Webconsole:</span><br><span class="line">  |                |                 |                     | https:<span class="hljs-comment">//webconsole.paas.domain.tw</span></span><br><span class="line">  |    Internet    |                 |    <span class="hljs-number">192.168</span>.<span class="hljs-number">101.130</span>  |</span><br><span class="line">  |                |                 |                     | Cluster Console:</span><br><span class="line">  +-----^----+-----+                 |paas01.paas.domain.tw| https:<span class="hljs-comment">//console.apps.paas.domain.tw</span></span><br><span class="line">        |    |                       |     (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G, SSD)    |</span><br><span class="line">        |    |                       +---------+-----------+</span><br><span class="line">        |    |                                 |</span><br><span class="line">        |    | +---------------------+---------+-----------+----------------------+</span><br><span class="line">        |    | |                     |                     |                      |</span><br><span class="line">     +--+----v-+-----------+ +---------+-----------+ +---------+-----------+ +----------+----------+</span><br><span class="line">     |     Infra   node    | |      AP    node     | |      AP   node      | |      AP   node      |</span><br><span class="line">     |---------------------| |---------------------| |---------------------| |---------------------|</span><br><span class="line">     |                     | |                     | |                     | |                     |</span><br><span class="line">     |   <span class="hljs-number">192.168</span>.<span class="hljs-number">101.131</span>   | |    <span class="hljs-number">192.168</span>.<span class="hljs-number">101.132</span>  | |   <span class="hljs-number">192.168</span>.<span class="hljs-number">101.133</span>   | |    <span class="hljs-number">192.168</span>.<span class="hljs-number">101.134</span>  |</span><br><span class="line">     |                     | |                     | |                     | |                     |</span><br><span class="line">     |paas02.paas.domain.tw| |paas03.paas.domain.tw| |paas04.paas.domain.tw| |paas05.paas.domain.tw|</span><br><span class="line">     |       (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G)       | |       (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G)       | |        (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G)      | |        (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G)      |</span><br><span class="line">     +---------------------+ +---------------------+ +---------------------+ +---------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h3><ul>
<li>Master node 主要包含了三個 Core Componet (Control plane)<ul>
<li><strong>ETCD</strong>: 用於保存cluster狀態及配置</li>
<li><strong>API server</strong>: Kubernetes API service的驗證以及pod配置。另外也掌管 pod scheduling and 訊息同步</li>
<li><strong>Conroller Manager Server</strong>: Controller Manager 主要透過ETCD上的資料對cluster 物件進行 replication controll，並透過 API 強制將物件執行至指定狀態</li>
</ul>
</li>
<li>Control plane 在 OKD 3.10 之後會透過 static pod 的形式存在於 Master 中，它們的設定 yaml 檔會存在於 /etc/origin/node/pods 中，有必要時可以對其設定進行調整</li>
</ul>
<figure class="highlight rust hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">                             +-------------------------+</span><br><span class="line">                             | Control Plan Static Pod |</span><br><span class="line">                             | +---------------------+ |</span><br><span class="line">+---------------------+   +----+        ETCD         | |</span><br><span class="line">|     Master node     |   |  | +---------------------+ |</span><br><span class="line">|---------------------|   |  |                         |</span><br><span class="line">|                     |   |  | +---------------------+ |</span><br><span class="line">|    <span class="hljs-number">192.168</span>.<span class="hljs-number">101.130</span>  +---+----+     API Server      | |</span><br><span class="line">|                     |   |  | +---------------------+ |</span><br><span class="line">|paas01.paas.domain.tw|   |  |                         |</span><br><span class="line">|     (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G, SSD)    |   |  | +---------------------+ |</span><br><span class="line">+---------------------+   +----+  Controller Server  | |</span><br><span class="line">                             | +---------------------+ |</span><br><span class="line">                             +-------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Infra-Node"><a href="#Infra-Node" class="headerlink" title="Infra Node"></a>Infra Node</h3><ul>
<li>Infra node目前規劃上主要會存在下列幾個Componets<ul>
<li><strong>Route (HAProxy)</strong>: HAProxy 主要負責 HTTP/HTTPS based 的網路流量，Openshift 預設採用 HAProxy。 如果有 Nginx 需要也可透過 Nginx 將 HAProxy 置換成 Nginx ingress controller.</li>
<li><strong>Openshift Monitor</strong>: 主要會透過 Cluster monitoring operator 去部署 prometheus and grafana</li>
<li><strong>Metrics</strong>: kube-state-metrics，會負責監控 cluster metrics 並提供HPA 功能</li>
</ul>
</li>
<li><p>Production 環境建議infra node 分拆角色</p>
<ul>
<li>Ingress, Egress, External IP 相關 service 合併為一個 routing node 只負責流量控管</li>
<li>Metrics Monitoring 相關 service 獨立出一個 Monitor node</li>
<li>logging EFK 自己有自己的 logging node</li>
</ul>
<ul>
<li>Remark: 因為resource不足的緣故，故沒有安裝EFK</li>
</ul>
</li>
</ul>
<figure class="highlight rust hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">                             +-------------------------+</span><br><span class="line">                             |          Pod            |</span><br><span class="line">                             | +---------------------+ |</span><br><span class="line">+---------------------+   +----+    Route(HAProxy)   | |</span><br><span class="line">|    Infra  node      |   |  | +---------------------+ |</span><br><span class="line">|---------------------|   |  |                         |</span><br><span class="line">|                     |   |  | +---------------------+ |</span><br><span class="line">|    <span class="hljs-number">192.168</span>.<span class="hljs-number">101.131</span>  +---+----+  Openshift Monitor  | |</span><br><span class="line">|                     |   |  | +---------------------+ |</span><br><span class="line">|paas02.paas.domain.tw|   |  |                         |</span><br><span class="line">|        (<span class="hljs-number">8</span>C/<span class="hljs-number">8</span>G)      |   |  | +---------------------+ |</span><br><span class="line">+---------------------+   +----+    Metrics Server   | |</span><br><span class="line">                             | +---------------------+ |</span><br><span class="line">                             +-------------------------+</span><br></pre></td></tr></table></figure>
<h2 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h2><p>安裝前需要確認以下幾個項目：</p>
<ul>
<li>所有節點的網路之間可以互相溝通。</li>
<li>部署節點對其他節點不需要 SSH 密碼即可登入。</li>
<li>所有節點都擁有 <code>root</code> 權限，並且不需要輸入密碼。</li>
<li>所有節點需要安裝 Python，CentOS 預設應該都會裝。</li>
<li>所有節點需要設定 /etc/hosts 解析到所有主機。</li>
<li>部署節點(Basion主機) 需要安裝 Ansible。</li>
</ul>
<blockquote>
<p>建議部署這邊可以透過一台在同網域的 <code>Basion主機</code> 直接操作連線至多台主機環境</p>
</blockquote>
<h3 id="設置主機名"><a href="#設置主機名" class="headerlink" title="設置主機名"></a>設置主機名</h3><p>為方便識別裸機機器對應名稱，這邊修改每台實體機 <code>hostname</code></p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#  Master</span></span><br><span class="line">$　hostnamectl <span class="hljs-built_in">set</span>-hostname paas01.paas.domain.tw</span><br><span class="line"><span class="hljs-comment">#  Infra node</span></span><br><span class="line">$　hostnamectl <span class="hljs-built_in">set</span>-hostname paas02.paas.domain.tw</span><br><span class="line"><span class="hljs-comment">#  AP node</span></span><br><span class="line">$　hostnamectl <span class="hljs-built_in">set</span>-hostname paas01.paas.domain.tw</span><br><span class="line">$　hostnamectl <span class="hljs-built_in">set</span>-hostname paas01.paas.domain.tw</span><br><span class="line">$　hostnamectl <span class="hljs-built_in">set</span>-hostname paas01.paas.domain.tw</span><br></pre></td></tr></table></figure>
<h3 id="Network-Setting-並設置-「DNS-Server」"><a href="#Network-Setting-並設置-「DNS-Server」" class="headerlink" title="Network Setting 並設置 「DNS Server」"></a>Network Setting 並設置 「DNS Server」</h3><p>配置 CentOS 系統網路，透過CLI設定配置當前實體機網卡(ifcfg-xxx):</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash"> ifcfg-em1 是網卡名稱，如果是 eth0 修改對應網卡 ifcfg-eth0</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> vim /etc/sysconfig/network-scripts/ifcfg-em1</span></span><br><span class="line"></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=em1</span><br><span class="line">UUID=7c200433-ead4-43e3-a571-0dfeb0515a96</span><br><span class="line">DEVICE=em1</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.101.XXX　　　　</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.101.254</span><br><span class="line">DNS1=8.8.8.8</span><br><span class="line">IPV6_PRIVACY=no</span><br><span class="line">DOMAIN=paas.domain.tw</span><br></pre></td></tr></table></figure>
<h3 id="設定完後重啟-NetworkManager"><a href="#設定完後重啟-NetworkManager" class="headerlink" title="設定完後重啟 NetworkManager"></a>設定完後重啟 NetworkManager</h3><figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl restart NetworkManager</span><br><span class="line">$ cat /etc/resolv.conf </span><br><span class="line"></span><br><span class="line">search paas.domain.tw <span class="hljs-comment"># restart後會增加cluster.local</span></span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure>
<h3 id="Bastion-node-設定-節點設置免-SSH-密碼"><a href="#Bastion-node-設定-節點設置免-SSH-密碼" class="headerlink" title="Bastion node 設定 (節點設置免 SSH 密碼)"></a>Bastion node 設定 (節點設置免 SSH 密碼)</h3><ul>
<li>在部署環境建議透過 Bastion 的方式進行 Cluster部署，Bastion 可以是一台Notebook 也可以是一台固定的機器，最主要我們會透過Bastion機對整個 Cluster進行部署及操作</li>
<li>在接下來的部署，我們會統一在 Bastion 機上面進行 Inventory 撰寫以及透過ansible 建置 Openshift</li>
<li>在撒 ansible playbook 前，因為 ansible 會透過 ssh 對 cluster machine 進行指令操作，所以我們要先對 cluster nodes 進行 ssh 免密碼登入設定</li>
</ul>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> ssh-keygen </span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:YWid3TtIfGyFM8MsaZf1YYp9RcgC60plBJrhPNqEEDk root@basion.paas.domain.tw</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|  oo  . ..o= =o=o|</span><br><span class="line">|  E. + * =++&amp;.=.o|</span><br><span class="line">|   .. X =.B+=B ..|</span><br><span class="line">|     = o * + ..  |</span><br><span class="line">|    . . S o o    |</span><br><span class="line">|       . .   .   |</span><br><span class="line">|        .        |</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">    ssh-copy-id root@paas0$seq.paas.domain.tw; \</span><br><span class="line">    echo paas0$seq;\</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash"><span class="hljs-built_in">test</span> ssh connection</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">    ssh root@paas0$seq.paas.domain.tw echo paas0$seq; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="檢查-SELinux-是否開啟-Enforcing-SELinux"><a href="#檢查-SELinux-是否開啟-Enforcing-SELinux" class="headerlink" title="檢查 SELinux 是否開啟 (Enforcing SELinux)"></a>檢查 SELinux 是否開啟 (Enforcing SELinux)</h3><p>要安裝 OpenShift 或是 OKD，都必須 啟用 SELinux，否則安裝會失敗。必須設定 SELINUX=enforcing 與 SELINUXTYPE=targeted。</p>
<p>修改方式如下：</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> cat /etc/selinux/config</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> enforcing</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> seenforcing</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> selinuxenabled</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> sestatus</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> cat /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash"> This file controls the state of SELinux on the system.</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash"> SELINUX= can take one of these three values:</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">     enforcing - SELinux security policy is enforced.</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">     permissive - SELinux prints warnings instead of enforcing.</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">     disabled - No SELinux policy is loaded.</span></span><br><span class="line">SELINUX=enforcing</span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash"> SELINUXTYPE= can take one of three values:</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">     targeted - Targeted processes are protected,</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">     minimum - Modification of targeted policy. Only selected processes are protected.</span></span><br><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash">     mls - Multi Level Security protection.</span></span><br><span class="line">SELINUXTYPE=targeted</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">    ssh root@paas0$seq.paas.domain.tw sestatus; \</span><br><span class="line">    echo paas0$seq;\</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="配置-DNS-設定"><a href="#配置-DNS-設定" class="headerlink" title="配置 DNS 設定"></a>配置 DNS 設定</h2><p>此次實驗請於 Domain 提供平台，設置「區域檔紀錄」類型 A 配置每個節點如下配置：</p>
<table>
<thead>
<tr>
<th>IP Address</th>
<th>Hostname</th>
<th>Type</th>
<th>TTL</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.101.130</td>
<td>paas01.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
<tr>
<td>192.168.101.131</td>
<td>paas02.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
<tr>
<td>192.168.101.132</td>
<td>paas03.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
<tr>
<td>192.168.101.133</td>
<td>paas04.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
<tr>
<td>192.168.101.134</td>
<td>paas05.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
<tr>
<td>192.168.101.131</td>
<td>*.apps.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
<tr>
<td>192.168.101.130</td>
<td>webconsole.paas.domain.tw</td>
<td>A</td>
<td>3600</td>
</tr>
</tbody>
</table>
<p><strong>remark</strong>: 部分DNS service 有提供設定wildcard domain 的服務，如果沒有提供的話，建議之後在上面透過Route 進出的apps，可以透過正向表列方式將domain指向 infra node</p>
<h2 id="安裝依賴套件-Install-dependency-packages"><a href="#安裝依賴套件-Install-dependency-packages" class="headerlink" title="安裝依賴套件 (Install dependency packages)"></a>安裝依賴套件 (Install dependency packages)</h2><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">    ssh root@paas0$seq.paas.domain.tw  yum install wget git net-tools bind-utils iptables-services bridge-utils bash-completion kexec-tools sos psacct bash-completion.noarch bash-completion-extras.noarch python-passlib NetworkManager -y</span><br><span class="line">    echo paas0$seq;\</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="安裝-Docker-Install-docker"><a href="#安裝-Docker-Install-docker" class="headerlink" title="安裝 Docker (Install docker)"></a>安裝 Docker (Install docker)</h3><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw yum install docker-1.13.1 -y;</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw echo pupaas0$seq done;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw systemctl enable docker;</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw systemctl restart docker ;</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw echo pupaas0$seq done;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> &#123;1..5&#125;;</span></span><br><span class="line">do</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw docker info | grep Version;</span><br><span class="line">ssh root@paas0$seq.paas.domain.tw echo pupaas0$seq done;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="安裝-Ansible"><a href="#安裝-Ansible" class="headerlink" title="安裝 Ansible"></a>安裝 Ansible</h2><p>此部分於部署節點 (此實驗採用 <code>Master節點</code>） 啟用 EPEL 倉庫以安裝 Ansible</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#</span><span class="hljs-bash"> 全局禁用EPEL套件庫，以便在安裝的後續步驟中不會有狀況</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> yum -y install epel-release;</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> yum -y --enablerepo=epel install ansible pyOpenSSL;</span></span><br></pre></td></tr></table></figure>
<h2 id="Openshift-Ansible-下載"><a href="#Openshift-Ansible-下載" class="headerlink" title="Openshift Ansible 下載"></a>Openshift Ansible 下載</h2><figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> wget https://github.com/openshift/openshift-ansible/archive/openshift-ansible-3.11.136-1.zip</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> yum install unzip</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> unzip openshift-ansible-3.11.136-1.zip</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-built_in">cd</span> openshift-ansible-openshift-ansible-3.11.136-1/</span></span><br><span class="line">...</span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> <span class="hljs-built_in">cd</span> ..</span></span><br><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> cp openshift-ansible-openshift-ansible-3.11.136-1/ansible.cfg .</span></span><br></pre></td></tr></table></figure>
<h2 id="配置-Openshift-Ansible-「inventory-file」-描述"><a href="#配置-Openshift-Ansible-「inventory-file」-描述" class="headerlink" title="配置 Openshift Ansible 「inventory file」 描述"></a>配置 Openshift Ansible 「inventory file」 描述</h2><h2 id="Inventory"><a href="#Inventory" class="headerlink" title="Inventory"></a>Inventory</h2><ul>
<li>Inventory 主要是設定整個Cluster 的重要角色</li>
<li>這次的 Inventory 我們主要有幾個重點<ul>
<li><strong>Core Settings</strong>: 主要 core componets 的設定</li>
<li><strong>Container Runtime Setting</strong>: 這次我們主要會將Container runtime 轉換為RedHat 的另一個 Container runtime 專案  <a href="https://cri-o.io/" target="_blank" rel="noopener">CRIO</a></li>
<li><strong>CA Expired Date Setting</strong>: 將憑證日期延長至20年</li>
<li>因為部分的 add-on 有 persistent volume 需要(e.g. EFK)，其餘設定都暫時先用設定，夠過後續安裝的方式安裝。</li>
</ul>
</li>
</ul>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#reate an OSEv3 group that contains the masters and nodes groups</span></span><br><span class="line">[OSEv3:children]</span><br><span class="line">masters</span><br><span class="line">nodes</span><br><span class="line">etcd</span><br><span class="line"><span class="hljs-comment">#</span></span><br><span class="line"><span class="hljs-comment"># # Set variables common for all OSEv3 hosts</span></span><br><span class="line">[OSEv3:vars]</span><br><span class="line"><span class="hljs-comment">##</span></span><br><span class="line">openshift_disable_check=disk_availability,docker_storage,memory_availability,docker_image_availability,package_version</span><br><span class="line"><span class="hljs-comment">## # SSH user, this user should allow ssh based auth without requiring a password</span></span><br><span class="line">ansible_ssh_user=root</span><br><span class="line"></span><br><span class="line">debug_level=2</span><br><span class="line"><span class="hljs-comment">##</span></span><br><span class="line"><span class="hljs-comment">#Core Settings</span></span><br><span class="line"><span class="hljs-comment">#-----------------------------------------------------</span></span><br><span class="line">openshift_image_tag=<span class="hljs-string">"v3.11.0"</span></span><br><span class="line">openshift_pkg_version=<span class="hljs-string">"-3.11.0-1.el7.git.0.62803d0"</span></span><br><span class="line">openshift_version=<span class="hljs-string">"3.11.0"</span></span><br><span class="line">openshift_release=<span class="hljs-string">"3.11.0"</span></span><br><span class="line">openshift_master_default_subdomain=apps.paas.domain.tw</span><br><span class="line">openshift_deployment_type=origin</span><br><span class="line">openshift_hosted_infra_selector=<span class="hljs-string">""</span></span><br><span class="line">openshift_master_cluster_hostname=webconsole.paas.domain.tw</span><br><span class="line">openshift_master_cluster_public_hostname=webconsole.paas.domain.tw</span><br><span class="line">openshift_master_identity_providers=[&#123;<span class="hljs-string">'name'</span>: <span class="hljs-string">'htpasswd_auth'</span>, <span class="hljs-string">'login'</span>: <span class="hljs-string">'true'</span>, <span class="hljs-string">'challenge'</span>: <span class="hljs-string">'true'</span>, <span class="hljs-string">'kind'</span>: <span class="hljs-string">'HTPasswdPasswordIdentityProvider'</span>&#125;]</span><br><span class="line">openshift_master_console_port=8443</span><br><span class="line">openshift_master_api_port=8443</span><br><span class="line"><span class="hljs-comment">#-----------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#Container runtime setting</span></span><br><span class="line"><span class="hljs-comment">#-----------------------------------------------------</span></span><br><span class="line"><span class="hljs-comment">#if you wanna change the crio</span></span><br><span class="line"><span class="hljs-comment"># https://docs.openshift.com/container-platform/3.11/crio/crio_runtime.html</span></span><br><span class="line">openshift_use_crio=True</span><br><span class="line">openshift_use_crio_only=False</span><br><span class="line">openshift_crio_enable_docker_gc=False</span><br><span class="line">openshift_crio_docker_gc_node_selector=&#123;<span class="hljs-string">'runtime'</span>: <span class="hljs-string">'cri-o'</span>&#125;</span><br><span class="line"><span class="hljs-comment">#-----------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">#CA expired date setting</span></span><br><span class="line"><span class="hljs-comment">#-----------------------------------------------------</span></span><br><span class="line">openshift_ca_cert_expire_days=7300</span><br><span class="line">openshift_node_cert_expire_days=7300</span><br><span class="line">openshift_master_cert_expire_days=7300</span><br><span class="line">etcd_ca_default_days=7300</span><br><span class="line"><span class="hljs-comment">#-----------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">osm_use_cockpit=<span class="hljs-literal">true</span></span><br><span class="line">osm_cockpit_plugins=[<span class="hljs-string">'cockpit-kubernetes'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">## # host group for masters</span></span><br><span class="line">[masters]</span><br><span class="line">paas01.paas.domain.tw</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">## # host group for etcd</span></span><br><span class="line">[etcd]</span><br><span class="line">paas01.paas.domain.tw</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">## # host group for nodes</span></span><br><span class="line">[nodes]</span><br><span class="line">paas01.paas.domain.tw openshift_node_group_name=<span class="hljs-string">'node-config-master-crio'</span></span><br><span class="line">paas02.paas.domain.tw openshift_node_group_name=<span class="hljs-string">'node-config-infra-crio'</span></span><br><span class="line">paas03.paas.domain.tw openshift_node_group_name=<span class="hljs-string">'node-config-compute-crio'</span></span><br><span class="line">paas04.paas.domain.tw openshift_node_group_name=<span class="hljs-string">'node-config-compute-crio'</span></span><br><span class="line">paas05.paas.domain.tw openshift_node_group_name=<span class="hljs-string">'node-config-compute-crio'</span></span><br></pre></td></tr></table></figure>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li>安裝 pre requisites rpm</li>
<li>production mode 建議透過offline install 的方式安裝，保存安裝時所使用的rpm檔<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i inventory.ini openshift-ansible-openshift-ansible-3.11.136-1/playbooks/prerequisites.yml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Deploy-Cluster"><a href="#Deploy-Cluster" class="headerlink" title="Deploy Cluster"></a>Deploy Cluster</h2><ul>
<li>開始部署節點<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i inventory.ini openshift-ansible-openshift-ansible-3.11.136-1/playbooks/deploy_cluster.yml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="後續設定"><a href="#後續設定" class="headerlink" title="後續設定"></a>後續設定</h2><ul>
<li>增加 admin 帳號 (登入webconsole)</li>
<li>inventory 一開始預設有指定透過/etc/origin/master/htpasswd 作為基本的 identity provider 驗證<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ htpasswd -c /etc/origin/master/htpasswd admin</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>對 htpasswd admin user 進行cluster role binding (cluster-admin)</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ oc adm policy add-cluster-role-to-user cluster-admin admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>最後我們就可以透過inventory 設定的url登入Openshift webconsole 介面了</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Webconsole: https://webconsole.paas.domain.tw:8443</span><br><span class="line">Cluster console: https://console.apps.domain.tw</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/ansible/">ansible</a><a class="link-muted mr-2" rel="tag" href="/tags/openshift/">openshift</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/10/12/roca12day/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">中坑精南 補充兵 12 日心得</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/05/03/minikube-for-kubeflow/"><span class="level-item">利用 Minikube 快速測試部署 Kubeflow v0.5</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">評論</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: 'd6f36ce9e396f792688273fbfa2cdb89',
            repo: 'yylin1.github.io',
            owner: 'yylin1',
            clientID: 'b987dbe607feaa22dfbb',
            clientSecret: '5f39d21439abee42e4c9029671e94af32bf9cbdf',
            admin: "yylin1",
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            
            
            enableHotKey: true
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="" src="/images/yiyang.png" alt="Yi Yang"></figure><p class="title is-size-4 is-block line-height-inherit">Yi Yang</p><p class="is-size-6 is-block">Software Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hsinchu, Taiwan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">21</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分類</p><a href="/categories"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">標籤</p><a href="/tags"><p class="title">25</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/yylin1" target="_blank" rel="noopener">追蹤</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/yylin1"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/frank.yiyanglin"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Envelope" href="mailto:frank.yylin@gmail.com"><i class="far fa-envelope"></i></a></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">文章目錄</h3><ul class="menu-list"><li><a class="is-flex" href="#實驗節點資訊"><span class="mr-2">1</span><span>實驗節點資訊</span></a></li><li><a class="is-flex" href="#實驗-部署節點架構圖"><span class="mr-2">2</span><span>實驗-部署節點架構圖</span></a><ul class="menu-list"><li><a class="is-flex" href="#OKD-System-Architecture"><span class="mr-2">2.1</span><span>OKD: System Architecture</span></a></li><li><a class="is-flex" href="#Master-Node"><span class="mr-2">2.2</span><span>Master Node</span></a></li><li><a class="is-flex" href="#Infra-Node"><span class="mr-2">2.3</span><span>Infra Node</span></a></li></ul></li><li><a class="is-flex" href="#事前準備"><span class="mr-2">3</span><span>事前準備</span></a><ul class="menu-list"><li><a class="is-flex" href="#設置主機名"><span class="mr-2">3.1</span><span>設置主機名</span></a></li><li><a class="is-flex" href="#Network-Setting-並設置-「DNS-Server」"><span class="mr-2">3.2</span><span>Network Setting 並設置 「DNS Server」</span></a></li><li><a class="is-flex" href="#設定完後重啟-NetworkManager"><span class="mr-2">3.3</span><span>設定完後重啟 NetworkManager</span></a></li><li><a class="is-flex" href="#Bastion-node-設定-節點設置免-SSH-密碼"><span class="mr-2">3.4</span><span>Bastion node 設定 (節點設置免 SSH 密碼)</span></a></li><li><a class="is-flex" href="#檢查-SELinux-是否開啟-Enforcing-SELinux"><span class="mr-2">3.5</span><span>檢查 SELinux 是否開啟 (Enforcing SELinux)</span></a></li></ul></li><li><a class="is-flex" href="#配置-DNS-設定"><span class="mr-2">4</span><span>配置 DNS 設定</span></a></li><li><a class="is-flex" href="#安裝依賴套件-Install-dependency-packages"><span class="mr-2">5</span><span>安裝依賴套件 (Install dependency packages)</span></a><ul class="menu-list"><li><a class="is-flex" href="#安裝-Docker-Install-docker"><span class="mr-2">5.1</span><span>安裝 Docker (Install docker)</span></a></li></ul></li><li><a class="is-flex" href="#安裝-Ansible"><span class="mr-2">6</span><span>安裝 Ansible</span></a></li><li><a class="is-flex" href="#Openshift-Ansible-下載"><span class="mr-2">7</span><span>Openshift Ansible 下載</span></a></li><li><a class="is-flex" href="#配置-Openshift-Ansible-「inventory-file」-描述"><span class="mr-2">8</span><span>配置 Openshift Ansible 「inventory file」 描述</span></a></li><li><a class="is-flex" href="#Inventory"><span class="mr-2">9</span><span>Inventory</span></a></li><li><a class="is-flex" href="#Prerequisites"><span class="mr-2">10</span><span>Prerequisites</span></a></li><li><a class="is-flex" href="#Deploy-Cluster"><span class="mr-2">11</span><span>Deploy Cluster</span></a></li><li><a class="is-flex" href="#後續設定"><span class="mr-2">12</span><span>後續設定</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">連結</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://chlin62.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">林大工程師</span></span><span class="level-right"><span class="level-item tag">chlin62.github.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分類</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Ansible/"><span class="level-start"><span class="level-item">Ansible</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Deploy/"><span class="level-start"><span class="level-item">Deploy</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Docker/"><span class="level-start"><span class="level-item">Docker</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Driver/"><span class="level-start"><span class="level-item">Driver</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Kubeflow/"><span class="level-start"><span class="level-item">Kubeflow</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linkpack/"><span class="level-start"><span class="level-item">Linkpack</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Note/"><span class="level-start"><span class="level-item">Note</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Openshift/"><span class="level-start"><span class="level-item">Openshift</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Zabbix/"><span class="level-start"><span class="level-item">Zabbix</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><a class="media-left" href="/2020/06/16/singularity-introduction/"><p class="image is-64x64"><img class="thumbnail" src="/images/singularity.jpg" alt="Singularity 基礎介紹"></p></a><div class="media-content size-small"><p><time dateTime="2020-06-16T14:50:14.000Z">2020-06-16</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/16/singularity-introduction/">Singularity 基礎介紹</a></p><p class="is-uppercase"></p></div></article><article class="media"><a class="media-left" href="/2019/12/31/2019-retrospect-prospect/"><p class="image is-64x64"><img class="thumbnail" src="/images/2019_end.png" alt="2019 年度總結"></p></a><div class="media-content size-small"><p><time dateTime="2019-12-31T03:50:00.000Z">2019-12-31</time></p><p class="title is-6"><a class="link-muted" href="/2019/12/31/2019-retrospect-prospect/">2019 年度總結</a></p><p class="is-uppercase"></p></div></article><article class="media"><a class="media-left" href="/2019/10/12/roca12day/"><p class="image is-64x64"><img class="thumbnail" src="/images/roca12.jpg" alt="中坑精南 補充兵 12 日心得"></p></a><div class="media-content size-small"><p><time dateTime="2019-10-12T06:38:05.000Z">2019-10-12</time></p><p class="title is-6"><a class="link-muted" href="/2019/10/12/roca12day/">中坑精南 補充兵 12 日心得</a></p><p class="is-uppercase"></p></div></article><article class="media"><a class="media-left" href="/2019/08/12/openshift-ansible-v3-11/"><p class="image is-64x64"><img class="thumbnail" src="/images/openshift%203.11.jpg" alt="透過 Ansible 快速部署 OpenShift 3.11(OKD) 叢集"></p></a><div class="media-content size-small"><p><time dateTime="2019-08-12T15:41:13.000Z">2019-08-12</time></p><p class="title is-6"><a class="link-muted" href="/2019/08/12/openshift-ansible-v3-11/">透過 Ansible 快速部署 OpenShift 3.11(OKD) 叢集</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Openshift/">Openshift</a></p></div></article><article class="media"><a class="media-left" href="/2019/05/03/minikube-for-kubeflow/"><p class="image is-64x64"><img class="thumbnail" src="/images/minikube_for_kubeflow.jpg" alt="利用 Minikube 快速測試部署 Kubeflow v0.5"></p></a><div class="media-content size-small"><p><time dateTime="2019-05-03T15:46:54.000Z">2019-05-03</time></p><p class="title is-6"><a class="link-muted" href="/2019/05/03/minikube-for-kubeflow/">利用 Minikube 快速測試部署 Kubeflow v0.5</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Kubeflow/">Kubeflow</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">彙整</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/11/"><span class="level-start"><span class="level-item">十一月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/10/"><span class="level-start"><span class="level-item">十月 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">標籤</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/API/"><span class="tag">API</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Container/"><span class="tag">Container</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GPU/"><span class="tag">GPU</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NVIDIA-Driver/"><span class="tag">NVIDIA Driver</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Retrospect/"><span class="tag">Retrospect</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Singularity/"><span class="tag">Singularity</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UI/"><span class="tag">UI</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bastion/"><span class="tag">bastion</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/benchmark/"><span class="tag">benchmark</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deploy/"><span class="tag">deploy</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/distributed/"><span class="tag">distributed</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubecon/"><span class="tag">kubecon</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubeflow/"><span class="tag">kubeflow</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubernetes/"><span class="tag">kubernetes</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linpack/"><span class="tag">linpack</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/microk8s/"><span class="tag">microk8s</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/minikube/"><span class="tag">minikube</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openshift/"><span class="tag">openshift</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/parmeter-server/"><span class="tag">parmeter server</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/quickstart/"><span class="tag">quickstart</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/scheduler/"><span class="tag">scheduler</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ubuntu/"><span class="tag">ubuntu</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zabbix/"><span class="tag">zabbix</span><span class="tag is-grey-lightest">2</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">訂閱 Email</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="訂閱"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/artificial-intelligence.png" alt="Yi Yang&#039;s Blog" height="28"></a><p class="size-small"><span>&copy; 2020 Yi Yang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-TW");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://yylin1.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到頁首" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="請輸入關鍵字..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"請輸入關鍵字...","untitled":"(Untitled)","posts":"文章","pages":"Pages","categories":"分類","tags":"標籤"});
        });</script></body></html>